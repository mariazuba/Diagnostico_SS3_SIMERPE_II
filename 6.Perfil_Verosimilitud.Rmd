---
title: "Perfil de verosimilitud"
date: '`r format(Sys.Date(),"Última actualización: %B, %d, %Y")`'
---



```{css,echo=FALSE}


.scroll-200{
            max-height: 200px; 
            overflow-y: auto; 
            background-color: #f1f1f1;
            }
```



```{css,echo=FALSE}

/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 100px;
  margin: 2em 20px 40px 20px;
  background-image: url("LOGO_2SN_recortado.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}

```



```{r global-options, include=FALSE}
knitr::opts_chunk$set(eval=T,echo=T, warning=FALSE, message=FALSE,class.output="scroll-200",fig.align = "center")
```

 Código original extraído desde  https://github.com/jabbamodel/ss3diags
https://github.com/jabbamodel/ss3diags/blob/master/Cookbook/Likelihood_profile_R0_example.R


# Instalar librerías

```{r eval=FALSE}
# devtools::install_github("jabbamodel/ss3diags")
# install.packages('r4ss')
# install.packages('here')

```


# Cargar librerías

```{r}
library(here)
library(r4ss)
library(ss3diags)
library(doParallel) # facilita la ejecución paralela en R
detectCores()
registerDoParallel(8)

```

```{r}
#'*Directorio base*

dir.base<-here("Escenarios_SS3","S1")
```

```{r}
#'*Crear un nuevo directorio para el `Perfil_Verosimilitud`*

dirname.R0.profile <- here("Perfil_Verosimilitud")
dir.create(path=dirname.R0.profile, showWarnings = TRUE, recursive = TRUE)
```

```{r}
#'*Crear un subdirectorio llamado `plots_Verosimilitud`*

plotdir=paste0(dirname.R0.profile, "/plots_Verosimilitud_S1")
dir.create(path=plotdir, showWarnings = TRUE, recursive = TRUE)
```

```{r}
#'*Crear un subdirectorio llamado `S1`*

reference.dir <- paste0(dirname.R0.profile,'/S1') 
dir.create(path=reference.dir, showWarnings = TRUE, recursive = TRUE)
```

```{r}
#'*Copiar el resultado del modelo base completo en este directorio*

file.copy(Sys.glob(paste(dir.base, "*.*", sep="/"),
                   dirmark = FALSE),
                    reference.dir)
```

# Ejecutar SS3
```{r eval=FALSE}

# Identificar el directorio donde está el archivo ejecutable y copiarlo
exe_path <- here("Ejecutables_SS3","3.30.20_release")
file.copy(paste0(exe_path,"/ss_osx"),reference.dir)
#### Ejecutar el modelo ----
# Entramos en el directorio desde la terminal
system(paste0("cd ",reference.dir,"/"))
# Permitimos que el ordenador pueda abrir el ejecutable (terminal)
system(paste0("chmod 755 ",reference.dir,"/ss_osx"))

r4ss::run(dir=reference.dir, exe="ss_osx", skipfinished=FALSE)
```


```{r}
#'* 6. Leer la salida del modelo base `SS_output()`*

Base <- SS_output(dir=reference.dir)

```



```{r}
#'* 7. Copiar los archivos necesarios de `S1` al directorio `Perfil_Verosimilitud` con la función `copy_SS_inputs()` *
# 
# copy_SS_inputs(dir.old = reference.dir, 
#                dir.new =  dirname.R0.profile,
#                copy_exe = TRUE,
#                verbose = FALSE)

```



```{r}
#'* 8. Leer los archivos del modelo `SS_read()` *

inputs <- r4ss::SS_read(dir = reference.dir,ss_new = FALSE, verbose = FALSE)

```


```{r}
#'* 9. Editar el archivo `control.ss` la fase de estimación recdev *

inputs$ctl$recdev_phase <- 1

```



```{r}
#'* 10. Editar el archivo starter para leer los valores de inicio *

inputs$start$init_values_src <- 0

```


```{r}
#'* 11. Vector de valores para el perfil *
R0.vec <- seq(7,9,0.2)  
Nprof.R0 <- length(R0.vec)
```



```{r}
#'* 12. Cambiar el nombre del archivo control en el archivo `starter.ss`*
inputs$start$ctlfile <- "control_modified.ss" 
```


```{r}
#'*13. Incluir prior_like para parámetros no estimados *
inputs$start$prior_like <- 1                                 
```

```{r}
#'* 14. Escribir los modelos modificados `SS_write()`*
r4ss::SS_write(inputs, dir = reference.dir, overwrite = TRUE)
```


```{r eval=F}
#'* 15. Ejecutar la función `SS_profile()` *
#?SS_profile()
# profile <- profile(dir=reference.dir, # directory
#                       model="ss_osx",#"ss_win",
#                       masterctlfile="control.ss",
#                       newctlfile="control_modified.ss",
#                       string="SR_LN(R0)",
#                       profilevec=R0.vec)

profile <- profile(
  dir = reference.dir,
  oldctlfile = "control.ss",
  newctlfile = "control_modified.ss",
  string = "SR_LN(R0)", # subset of parameter label
  profilevec = R0.vec,
  exe = "ss_osx"
)
```



```{r}
#'* 16. Leer los archivos de salida `SSgetoutput()` *
#'*(con nombres como Report1.sso, Report2.sso, etc.)*

prof.R0.models <- SSgetoutput(dirvec=reference.dir, 
                              keyvec=1:Nprof.R0, 
                              getcovar = FALSE) 
```


```{r}
#'*17. Resumir las salidas con la función `SSsummarize()`*  

prof.R0.summary <- SSsummarize(prof.R0.models)

```



```{r}
#'* 18. Identificar los componentes de Verosimilitud *

mainlike_components         <- c('TOTAL',"Survey", 'Length_comp',"Age_comp",'Size_at_age','Recruitment') 
mainlike_components_labels  <- c('Total likelihood','Index likelihood','Length likelihood',"Age likelihood",'Size_at_age likelihood','Recruitment likelihood') 
```



```{r}
#'* 19. Funciones para generar plots de perfil de verosimilitud*

#'*`SSplotProfile()`*
#png(file.path(plotdir,"R0_profile_plot.png"),width=7,height=4.5,res=300,units='in')
par(mar=c(5,4,1,1))

SSplotProfile(prof.R0.summary,           # summary object
              profile.string = "R0",     # substring of profile parameter
              profile.label=expression(log(italic(R)[0])), ymax=150,minfraction = 0.001,
              pheight=4.5, 
              print=FALSE, 
              plotdir=plotdir, 
              components = mainlike_components, 
              component.labels = mainlike_components_labels,
              add_cutoff = TRUE,
              cutoff_prob = 0.95)

Baseval <- round(Base$parameters$Value[grep("R0",Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,label=Baselab)
abline(v = Baseval, lty=2)
#dev.off()

```

```{r eval=F}
#'* Comparación de series de tiempo `SSplotComparisons()` *
labs <- paste("SR_Ln(R0) = ",R0.vec)
labs[which(round(R0.vec,2)==Baseval)] <- paste("SR_Ln(R0) = ",Baseval,"(Base model)")

SSplotComparisons(prof.R0.summary,
                  legendlabels=labs,
                  pheight=4.5,png=TRUE,
                  plotdir=plotdir,
                  legendloc='bottomleft')

```


```{r}
#'* R0_profile_plot_Length_like `PinerPlot()`* 
#png(file.path(plotdir,"R0_profile_plot_Length_like.png"),width=7,height=4.5,res=300,units='in')
par(mar=c(5,4,1,1))
PinerPlot(prof.R0.summary, 
          profile.string = "R0", 
          component = "Length_like",
          main = "Changes in length-composition likelihoods by fleet",
          add_cutoff = TRUE,
          cutoff_prob = 0.95)
Baseval <- round(Base$parameters$Value[grep("SR_LN",Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,label=Baselab)
abline(v = Baseval, lty=2)
#dev.off()
```


```{r}
#'* R0_profile_plot_Survey_like*
#png(file.path(plotdir,"R0_profile_plot_Survey_like.png"),width=7,height=4.5,res=300,units='in')
par(mar=c(5,4,1,1))
PinerPlot(prof.R0.summary, profile.string = "R0", component = "Surv_like",main = "Changes in Index likelihoods by fleet",
          add_cutoff = TRUE,
          cutoff_prob = 0.95, legendloc="topleft")
Baseval <- round(Base$parameters$Value[grep("SR_LN",Base$parameters$Label)],2)
Baselab <- paste(Baseval,sep="")
axis(1,at=Baseval,label=Baselab)
abline(v = Baseval, lty=2)
#dev.off()
```

